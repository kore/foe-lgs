#!/usr/bin/env php
<?php

function get(string $url): string {
    $cacheKey = __DIR__ . '/.cache/' . md5($url);
    if (file_exists($cacheKey)) {
        return file_get_contents($cacheKey);
    }

    $content = file_get_contents($url);
    file_put_contents($cacheKey, $content);
    return $content;
}

libxml_use_internal_errors(true);
$buildingListHtml = new \DOMDocument();
$buildingListHtml->loadHTML(get('https://forgeofempires.fandom.com/wiki/Great_Buildings'));

$xPath = new \DOMXPath($buildingListHtml);
$buildings = [];
foreach ($xPath->query('//table//big//a') as $buildingLink) {
    $buildings[] = (object) [
        'id' => substr(md5(trim($buildingLink->textContent)), 0, 8),
        'name' => trim($buildingLink->textContent),
        'link' => 'https://forgeofempires.fandom.com' . $buildingLink->getAttribute('href'),
        'ranks' => [],
    ];
}

foreach ($buildings as $buildingNumber => $building) {
    $buildingHtml = new \DOMDocument();
    $buildingHtml->loadHTML(get($building->link));

    $xPath = new \DOMXPath($buildingHtml);
    echo "Loading ", $building->name, PHP_EOL;
    foreach ($xPath->query('//div[@class="tabber"]//div[@class="tabbertab"]') as $rankTable) {
        $level = (int) substr($rankTable->getAttribute('title'), 4);
        $building->levels[$level] = (object) [
            'required' => false,
            'ranks' => [],
        ];

        foreach ($xPath->query('.//td', $rankTable) as $id => $rankNode) {
            $fp = $xPath->query('.//a[@title="Forge Point"]//following-sibling::text()', $rankNode)->item(0);
            $medals = $xPath->query('.//a[@title="Medals"]//following-sibling::text()', $rankNode)->item(0);
            $bp = $xPath->query('.//a[@title="Blueprints"]//following-sibling::text()', $rankNode)->item(0);

            $building->levels[$level]->ranks[] = (object) [
                'rank' => $id + 1,
                'fp' => $fp ? (int) preg_replace('([\\s,+])', '', $fp->textContent) : 0,
                'medals' => $medals ? (int) preg_replace('([\\s,+])', '', $medals->textContent) : 0,
                'bp' => $bp ? (int) preg_replace('([\\s,+])', '', $bp->textContent) : 0,
            ];
        }
    }

    foreach ($xPath->query('//table[@class="FoETable WrapTable floatheader"]//tr') as $rankTable) {
        $level = false;
        $required = false;

        foreach ($xPath->query('.//td', $rankTable) as $id => $rankNode) {
            if (preg_match('(â†’\\s*(\\d+))', $rankNode->textContent, $match)) {
                $level = (int) $match[1];
            }

            if (preg_match('(^\\s*([\\d,]+)\\s*$)', $rankNode->textContent, $match)) {
                $required = (int) preg_replace('([\\s,+])', '', $match[1]);
            }

            if ($level && $required) {
                if (!isset($building->levels[$level])) {
                    continue 2;
                }

                $building->levels[$level]->required = $required;
                continue 2;
            }
        }
    }
}

usort(
    $buildings,
    function ($a, $b) {
        return $a->name <=> $b->name;
    }
);

file_put_contents(__DIR__ . '/../src/js/data/buildings.json', json_encode($buildings));

echo "Done", PHP_EOL;
